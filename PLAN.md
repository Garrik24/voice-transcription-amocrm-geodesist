## Цель
Сделать автоматизацию: при переводе сделки в AmoCRM на этап **«Назначен»** отправлять геодезисту сообщение в **MAX** через Wappi (MAX API) с деталями выезда **без ссылки на сделку** и без финансовых данных.

## Контекст и ограничения
- Геодезисты **не имеют доступа** к AmoCRM (только телефон).
- Отправка должна фиксироваться в истории сделки (таймлайн) как факт отправки.
- Канал отправки: **MAX** через Wappi.
- Триггер: перевод сделки на этап «Назначен» (будем запускать через Digital Pipeline/робота AmoCRM шагом “Webhook”).
- Защита от дублей: повторная доставка webhook не должна приводить к спаму.

## Источник данных (что отправляем)
Сообщение геодезисту содержит:
- **Клиент**: имя/название контакта или “Не указано”
- **Телефон клиента**: телефон основного контакта или “Не указано”
- **Тип работ**: межевание/техплан/топосъёмка (из поля сделки) или “Не указано”
- **Адрес выезда**: из поля сделки или “Не указано”
- **Когда ехать**: “первая половина дня” / “вторая половина дня” (из поля сделки) или “Не указано”

Не отправляем:
- ссылку на сделку
- суммы/финансы

## Интеграции
### AmoCRM
- Триггеруем обработку из робота на этапе «Назначен» вебхуком в наш сервис.
- Для получения данных сделки/контакта используем AmoCRM API v4:
  - `GET /api/v4/leads/{lead_id}?with=contacts`
  - `GET /api/v4/contacts/{contact_id}`
- Для фиксации факта отправки используем примечание в сделку:
  - `POST /api/v4/leads/{lead_id}/notes` (note_type=common)

### Wappi MAX API
Отправка текста в MAX:
- `POST /maxapi/async/message/send?profile_id=...`
  - Header: `Authorization: <WAPPI_API_TOKEN>`
  - Body: `{ "recipient": "79...", "body": "..." }`

## Конфигурация (env)
Новые переменные окружения:
- `WAPPI_API_TOKEN` — API токен Wappi (header `Authorization`)
- `WAPPI_MAX_PROFILE_ID` — `profile_id` MAX профиля в Wappi
- `GEODESIST_1_PHONE` — телефон геодезиста 1 в формате `79...`
- `GEODESIST_2_PHONE` — телефон геодезиста 2 в формате `79...`
- `AMO_FIELD_GEODESIST` — идентификатор поля сделки, где выбирается геодезист (опционально, если передаём выбор прямо в webhook)
- `AMO_FIELD_WORK_TYPE` — id поля “Тип работ”
- `AMO_FIELD_ADDRESS` — id поля “Адрес”
- `AMO_FIELD_TIME_SLOT` — id поля “Половина дня” (первая/вторая)

Примечание: на первом этапе можно упростить и передавать в webhook значения `geodesist`, `work_type`, `address`, `time_slot`, но целевой вариант — забирать из Amo по `lead_id`.

## Контракт webhook от робота AmoCRM (предлагаемый)
Endpoint сервиса: `POST /webhook/amocrm/geodesist-assigned`

Тело (JSON) от робота (рекомендуется):
```json
{
  "lead_id": 12345,
  "geodesist": "1"
}
```

Где `geodesist` — “1” или “2” (либо можно передавать сразу телефон).

## План работ (атомарно)
1) Создать модуль автоматизации в отдельной папке проекта:
   - `automations/geodesist_notification/`
   - Логика: собрать данные → отправить в MAX → записать примечание в сделку

2) Добавить клиент Wappi MAX API:
   - HTTP client на `POST /maxapi/async/message/send`
   - Валидация номера, обработка ошибок, таймауты

3) Добавить новый webhook endpoint в `main.py`:
   - Принимать JSON и form-urlencoded (на случай настроек робота)
   - Минимальная валидация: `lead_id` обязателен
   - Идемпотентность: in-memory дедуп по `(lead_id, geodesist, time_bucket)`

4) Реализовать получение данных сделки и контакта:
   - По `lead_id` → `lead` + `contacts`
   - По первому контакту → имя + телефон (field_code PHONE)
   - Из `custom_fields_values` сделки → work_type/address/time_slot

5) Сформировать текст сообщения (без ссылки/финансов):
   - Короткий, структурированный формат (для копипаста)

6) Отправить сообщение геодезисту в MAX через Wappi.

7) Записать примечание в сделку:
   - “✅ Геодезисту отправлено в MAX …” + краткий дубликат ключевых полей

8) Обновить документацию и env template:
   - `ENV_EXAMPLE.txt`
   - (опционально) `README.md` раздел “Geodesist notification”

9) Минимальный тест-план (ручной):
   - В Amo перевести тестовую сделку в «Назначен» с геодезистом 1 → сообщение приходит
   - Повторный webhook → дубль не отправляется
   - Геодезист 2 → уходит на другой номер
   - Если нет телефона клиента/адреса → сообщение всё равно уходит с “Не указано”

