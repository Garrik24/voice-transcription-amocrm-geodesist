"""
–°–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ —á–µ—Ä–µ–∑ OpenAI GPT.
–ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏.
"""
import openai
import json
import logging
import re
from typing import List
from dataclasses import dataclass
from config import (
    GEMINI_API_KEY,
    GEMINI_MODEL,
    LLM_PROVIDER,
    OPENAI_API_KEY,
    OPENAI_MODEL,
    OPENAI_MAX_TOKENS,
    GEMINI_MAX_OUTPUT_TOKENS,
    ANALYSIS_TEMPERATURE,
    MAX_TRANSCRIPT_LENGTH,
    TRUNCATE_TRANSCRIPT_FOR_ANALYSIS,
)

logger = logging.getLogger(__name__)

_client: openai.AsyncOpenAI | None = None
_gemini_client = None


def _normalize_list_field(value) -> List[str]:
    """
    –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –ø–æ–ª–µ, –∫–æ—Ç–æ—Ä–æ–µ –º–æ–∂–µ—Ç –ø—Ä–∏–π—Ç–∏ –∫–∞–∫:
    - list[str]
    - –º–Ω–æ–≥–æ—Å—Ç—Ä–æ—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å –±—É–ª–ª–µ—Ç–∞–º–∏/–Ω—É–º–µ—Ä–∞—Ü–∏–µ–π
    - None
    """
    if value is None:
        return []
    if isinstance(value, list):
        return [str(x).strip() for x in value if str(x).strip()]
    if isinstance(value, str):
        items: List[str] = []
        for line in value.splitlines():
            s = line.strip()
            if not s:
                continue
            # —É–±–∏—Ä–∞–µ–º –±—É–ª–ª–µ—Ç—ã –∏ –Ω—É–º–µ—Ä–∞—Ü–∏—é –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏
            s = re.sub(r"^(\s*[-‚Ä¢]\s+|\s*\d+\s*[).]\s+)", "", s).strip()
            if s:
                items.append(s)
        return items
    # fallback
    s = str(value).strip()
    return [s] if s else []


def _get_client() -> openai.AsyncOpenAI:
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º OpenAI –∫–ª–∏–µ–Ω—Ç –ª–µ–Ω–∏–≤–æ.

    –í–∞–∂–Ω–æ –¥–ª—è –¥–µ–ø–ª–æ—è: –µ—Å–ª–∏ OPENAI_API_KEY –Ω–µ –∑–∞–¥–∞–Ω, —Å–µ—Ä–≤–∏—Å –≤—Å—ë —Ä–∞–≤–Ω–æ –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å
    (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–π –±–µ–∑ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏).
    """
    global _client
    if _client is not None:
        return _client
    if not OPENAI_API_KEY:
        raise RuntimeError("OPENAI_API_KEY –Ω–µ –∑–∞–¥–∞–Ω (–Ω—É–∂–µ–Ω –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–≤–æ–Ω–∫–æ–≤)")
    _client = openai.AsyncOpenAI(api_key=OPENAI_API_KEY)
    return _client


def _get_gemini_client():
    """
    –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Google GenAI (Gemini) –∫–ª–∏–µ–Ω—Ç –ª–µ–Ω–∏–≤–æ.

    –í–∞–∂–Ω–æ: –∫–ª—é—á–∏ –Ω–µ –≤–∞–ª–∏–º –Ω–∞ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ‚Äî —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∞–Ω–∞–ª–∏–∑–∞.
    """
    global _gemini_client
    if _gemini_client is not None:
        return _gemini_client
    if not GEMINI_API_KEY:
        raise RuntimeError("GEMINI_API_KEY –Ω–µ –∑–∞–¥–∞–Ω (–Ω—É–∂–µ–Ω –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–≤–æ–Ω–∫–æ–≤ —á–µ—Ä–µ–∑ Gemini)")
    # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤–Ω—É—Ç—Ä–∏, —á—Ç–æ–±—ã –Ω–µ –ø–∞–¥–∞—Ç—å, –µ—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.
    from google import genai

    _gemini_client = genai.Client(api_key=GEMINI_API_KEY)
    return _gemini_client


@dataclass
class CallAnalysis:
    """–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –∑–≤–æ–Ω–∫–∞ (–±–µ–∑ –æ—Ü–µ–Ω–æ–∫)"""
    client_name: str  # –§–ò–û –∏–ª–∏ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞
    manager_name: str  # –§–ò–û –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (–∏–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞)
    summary: str  # –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
    client_city: str  # –ì–æ—Ä–æ–¥ –∫–ª–∏–µ–Ω—Ç–∞
    work_type: str  # –¢–∏–ø —Ä–∞–±–æ—Ç—ã
    cost: str  # –°—Ç–æ–∏–º–æ—Å—Ç—å
    payment_terms: str  # –£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã
    call_result: str  # –ò—Ç–æ–≥ –∑–≤–æ–Ω–∫–∞
    next_contact_date: str  # –ö–æ–≥–¥–∞ —Å–≤—è–∑–∞—Ç—å—Å—è
    next_steps: List[str]  # –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (0-5)


# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–ê–≥–µ–Ω—Ç 1)
ANALYSIS_SYSTEM_PROMPT = """–¢—ã ‚Äî –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ –≥–µ–æ–¥–µ–∑–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∏–∑–≤–ª–µ—á—å –¢–û–õ–¨–ö–û –§–ê–ö–¢–´ –∏–∑ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –∏ –≤–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π JSON.
–ù–ï–õ–¨–ó–Ø –≤—ã–¥—É–º—ã–≤–∞—Ç—å. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç –≤ —Ç–µ–∫—Å—Ç–µ ‚Äî –ø–∏—à–∏ "–ù–µ —É–∫–∞–∑–∞–Ω–æ" –∏–ª–∏ "–ù–µ –æ–±—Å—É–∂–¥–∞–ª–∏" (–∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –Ω–∏–∂–µ).

–í–ê–ñ–ù–û –ü–†–û –†–û–õ–ò (—á–∏—Ç–∞–π –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ!):
- –ú–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–º–ø–∞–Ω–∏–∏: {manager_name}
- {manager_name} = –í–°–ï–ì–î–ê –º–µ–Ω–µ–¥–∂–µ—Ä (—ç—Ç–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏!)
- –ï—Å–ª–∏ –∫—Ç–æ-—Ç–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –æ—Ç –∏–º–µ–Ω–∏ –∫–æ–º–ø–∞–Ω–∏–∏ ‚Üí –º–µ–Ω–µ–¥–∂–µ—Ä
- –ù–ï –ø—É—Ç–∞–π —Ä–æ–ª–∏! –ï—Å–ª–∏ {manager_name} –≥–æ–≤–æ—Ä–∏—Ç "–º–Ω–µ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä" ‚Äî —ç—Ç–æ –ú–ï–ù–ï–î–ñ–ï–† –≥–æ–≤–æ—Ä–∏—Ç –æ —Å–≤–æ–∏—Ö –∑–∞–¥–∞—á–∞—Ö, –ù–ï –∫–ª–∏–µ–Ω—Ç!
- –û—Å—Ç–∞–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ ‚Üí –∫–ª–∏–µ–Ω—Ç—ã

–í–ê–ñ–ù–û –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤ (5+ –º–∏–Ω—É—Ç):
- –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–π –í–°–Æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—é –æ—Ç –Ω–∞—á–∞–ª–∞ –¥–æ –∫–æ–Ω—Ü–∞
- –ö–ª—é—á–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –õ–Æ–ë–û–ô —á–∞—Å—Ç–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ (–Ω–∞—á–∞–ª–æ, —Å–µ—Ä–µ–¥–∏–Ω–∞, –∫–æ–Ω–µ—Ü)
- –ù–µ –ø—Ä–æ–ø—É—Å–∫–∞–π –¥–µ—Ç–∞–ª–∏: —Å—Ç–æ–∏–º–æ—Å—Ç—å, —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã, –¥–∞—Ç—ã, –∞–¥—Ä–µ—Å–∞ –º–æ–≥—É—Ç —É–ø–æ–º–∏–Ω–∞—Ç—å—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑
- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —Å–∞–º—É—é –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–≤–µ—Ä—å –∫–æ–Ω–µ—Ü —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ ‚Äî —Ç–∞–º —á–∞—Å—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ü–û–õ–Ø (–∏—â–∏ –æ—Å–æ–±–µ–Ω–Ω–æ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ!):
client_city (–Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç):
  - –ò—â–∏: –≥–æ—Ä–æ–¥, —Ä–µ–≥–∏–æ–Ω, –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç, –∞–¥—Ä–µ—Å, "—è –∏–∑...", "–∂–∏–≤—É –≤...", "—É—á–∞—Å—Ç–æ–∫ –≤..."
  - –ü—Ä–∏–º–µ—Ä—ã: "–ö—Ä–∞—Å–Ω–æ–¥–∞—Ä", "–ú–æ—Å–∫–≤–∞", "–†–æ—Å—Ç–æ–≤", "–ø—Ä–∏–≥–æ—Ä–æ–¥ –†–æ—Å—Ç–æ–≤–∞", "–°–ù–¢ –°–æ–ª–Ω–µ—á–Ω—ã–π"

cost (—Å—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞):
  - –ò—â–∏: —Ü–µ–Ω–∞, —Å—Ç–æ–∏–º–æ—Å—Ç—å, —Å—É–º–º–∞, "—Ç—ã—Å—è—á", "—Ä—É–±–ª–µ–π", "‚ÇΩ", "—Å—Ç–æ–∏—Ç", "–æ–±–æ–π–¥–µ—Ç—Å—è"
  - –ü—Ä–∏–º–µ—Ä—ã: "25 000 ‚ÇΩ", "–¥–≤–∞–¥—Ü–∞—Ç—å —Ç—ã—Å—è—á", "–æ—Ç 20 000", "–æ–∫–æ–ª–æ 30 —Ç—ã—Å—è—á"
  - –í–ê–ñ–ù–û: –î–∞–∂–µ –µ—Å–ª–∏ –≥–æ–≤–æ—Ä—è—Ç "–ø—Ä–∏–º–µ—Ä–Ω–æ" –∏–ª–∏ "–æ–∫–æ–ª–æ" ‚Äî —ç—Ç–æ –°–¢–û–ò–ú–û–°–¢–¨!

payment_terms (—É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã):
  - –ò—â–∏: –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞, –∞–≤–∞–Ω—Å, 50/50, 100%, —Ä–∞—Å—Å—Ä–æ—á–∫–∞, "—Å–Ω–∞—á–∞–ª–∞", "–ø–æ—Ç–æ–º", "–ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"
  - –ü—Ä–∏–º–µ—Ä—ã: "50% –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞", "–æ–ø–ª–∞—Ç–∞ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è", "–ø–æ–ª–æ–≤–∏–Ω—É —Å–µ–π—á–∞—Å, –ø–æ–ª–æ–≤–∏–Ω—É –ø–æ—Ç–æ–º"

next_contact_date (–¥–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞):
  - –ò—â–∏: –¥–∞—Ç–∞, –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏, "–ø–æ–∑–≤–æ–Ω—é", "—Å–≤—è–∂—É—Å—å", "–ø–µ—Ä–µ–∑–≤–æ–Ω—é", "–∫–æ–≥–¥–∞ —Å–≤—è–∑–∞—Ç—å—Å—è"
  - –ü—Ä–∏–º–µ—Ä—ã: "—Å—Ä–µ–¥–∞", "15 —è–Ω–≤–∞—Ä—è", "–∑–∞–≤—Ç—Ä–∞ –≤ 14:00", "—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é", "–≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫"

–í–µ—Ä–Ω–∏ JSON —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏:
{
  "client_name": "–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ (–∫–∞–∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è) –∏–ª–∏ '–ö–ª–∏–µ–Ω—Ç'. –ò—â–∏ –≤ –Ω–∞—á–∞–ª–µ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.",
  "manager_name": "–ò–º—è/–§–ò–û –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏–∑ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –∏–ª–∏ —Ç–æ, —á—Ç–æ –ø–µ—Ä–µ–¥–∞–ª–∏ –≤ –ø–æ–ª–µ manager_name",
  "summary": "–†–∞–∑–≤—ë—Ä–Ω—É—Ç–∞—è —Å—É—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä–∞: –¥–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –∑–≤–æ–Ω–∫–æ–≤ 8‚Äì12 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö (5+ –º–∏–Ω) –¥–æ 20 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ö–≤–∞—Ç–∏: –Ω–∞—á–∞–ª–æ (–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ, –∑–∞–ø—Ä–æ—Å –∫–ª–∏–µ–Ω—Ç–∞), —Å–µ—Ä–µ–¥–∏–Ω—É (–æ–±—Å—É–∂–¥–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π, —Å—Ç–æ–∏–º–æ—Å—Ç–∏, —É—Å–ª–æ–≤–∏–π), –∫–æ–Ω–µ—Ü (—Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏, –∏—Ç–æ–≥, —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥). –ë–µ–∑ –≤–æ–¥—ã –∏ –ø–æ–≤—Ç–æ—Ä–æ–≤.",
  "client_city": "–ì–æ—Ä–æ–¥/—Ä–µ–≥–∏–æ–Ω –∏–ª–∏ '–ù–µ —É–∫–∞–∑–∞–Ω–æ'. –ò—â–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤, –∞–¥—Ä–µ—Å–æ–≤, —Ä–µ–≥–∏–æ–Ω–æ–≤.",
  "work_type": "–¢–∏–ø —Ä–∞–±–æ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: '–¢–æ–ø–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∞—è —Å—ä—ë–º–∫–∞ 1:500', '–ú–µ–∂–µ–≤–∞–Ω–∏–µ —É—á–∞—Å—Ç–∫–∞', '–í—ã–Ω–æ—Å –≥—Ä–∞–Ω–∏—Ü') –∏–ª–∏ '–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è'. –ò—â–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ —Ç–∏–ø–∞ —Ä–∞–±–æ—Ç.",
  "cost": "–°—Ç–æ–∏–º–æ—Å—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä: '25 000 ‚ÇΩ', '18 —Ç—ã—Å—è—á —Ä—É–±–ª–µ–π', '–æ—Ç 20 000') –∏–ª–∏ '–ù–µ –æ–±—Å—É–∂–¥–∞–ª–∏'. –ò—â–∏ –í–°–ï —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —Ü–µ–Ω, —Å—É–º–º, —Å—Ç–æ–∏–º–æ—Å—Ç–∏.",
  "payment_terms": "–£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: '50/50', '–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 50%', '100% –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è') –∏–ª–∏ '–ù–µ –æ–±—Å—É–∂–¥–∞–ª–∏'. –ò—â–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø—Ä–µ–¥–æ–ø–ª–∞—Ç—ã, —Ä–∞—Å—Å—Ä–æ—á–∫–∏, —É—Å–ª–æ–≤–∏–π –æ–ø–ª–∞—Ç—ã.",
  "call_result": "–ò—Ç–æ–≥: '–î–æ–≥–æ–≤–æ—Ä–∏–ª–∏—Å—å'/'–ö–ª–∏–µ–Ω—Ç –¥—É–º–∞–µ—Ç'/'–û—Ç–∫–∞–∑'/'–ü–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç—å'/'–û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–≥–æ–≤–æ—Ä' –∏ —Ç.–ø. –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ø—Ä–æ–≤–µ—Ä—å –∫–æ–Ω–µ—Ü —Ä–∞–∑–≥–æ–≤–æ—Ä–∞. –ï—Å–ª–∏ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ ‚Äî '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ'",
  "next_contact_date": "–ö–æ–≥–¥–∞ —Å–≤—è–∑–∞—Ç—å—Å—è (–µ—Å–ª–∏ –±—ã–ª–æ) –∏–Ω–∞—á–µ '–ù–µ —É–∫–∞–∑–∞–Ω–æ'. –ò—â–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞—Ç—ã, –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏, –≤—Ä–µ–º—è.",
  "next_steps": ["1-5 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–æ–≤ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø–æ –∏—Ç–æ–≥–∞–º —Ä–∞–∑–≥–æ–≤–æ—Ä–∞. –ò–∑–≤–ª–µ–∫–∞–π –∏–∑ –∫–æ–Ω—Ü–æ–≤–∫–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ []"]
}

–ü—Ä–∞–≤–∏–ª–∞ –∫–∞—á–µ—Å—Ç–≤–∞ summary:
- –ü–∏—à–∏ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º, –±–µ–∑ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞ –∏ –±–µ–∑ '–≤–æ–∑–º–æ–∂–Ω–æ/–Ω–∞–≤–µ—Ä–Ω–æ–µ'
- –ù–µ –≤—Å—Ç–∞–≤–ª—è–π –º—É—Å–æ—Ä–Ω—ã–µ —Å–ª–æ–≤–∞, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–Ω—É –º—ã—Å–ª—å
- –ù–µ –æ–±—Ä–µ–∑–∞–π –∫–æ–Ω—Ü–æ–≤–∫—É: –≤ summary –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ñ–∏–Ω–∞–ª —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –∏ —á–µ–º –∑–∞–∫–æ–Ω—á–∏–ª–∏
- –î–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤: –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–ø–æ–º—è–Ω–∏ –∫–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã –∏–∑ –Ω–∞—á–∞–ª–∞, —Å–µ—Ä–µ–¥–∏–Ω—ã –ò –∫–æ–Ω—Ü–∞
- –ï—Å–ª–∏ –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏ –∫–∞—à–∞/–æ–±—Ä—ã–≤–∫–∏ ‚Äî —Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ —Ç–æ—á–Ω–æ —è—Å–Ω–æ; –æ—Å—Ç–∞–ª—å–Ω–æ–µ –Ω–µ –¥–æ–¥—É–º—ã–≤–∞–π
- –ï—Å–ª–∏ —Ä–∞–∑–≥–æ–≤–æ—Ä –¥–ª–∏–Ω–Ω—ã–π ‚Äî summary –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ 20 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π, –Ω–æ –±–µ–∑ –≤–æ–¥—ã

–ü—Ä–∞–≤–∏–ª–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏:
- –ò—â–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤–æ –í–°–ï–ô —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏, –Ω–µ —Ç–æ–ª—å–∫–æ –≤ –Ω–∞—á–∞–ª–µ
- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π —Å–∞–º—É—é –ø–æ–ª–Ω—É—é/—Ç–æ—á–Ω—É—é –≤–µ—Ä—Å–∏—é
- –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –∫ –∫–æ–Ω—Ü—É —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ ‚Äî —Ç–∞–º —á–∞—Å—Ç–æ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏
- –ù–µ –ø–∏—à–∏ "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ" –µ—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –µ—Å—Ç—å –≤ —Ç–µ–∫—Å—Ç–µ ‚Äî –Ω–∞–π–¥–∏ –µ—ë!

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û JSON, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –±–µ–∑ Markdown.
"""


ANALYSIS_USER_PROMPT = """–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ä–∞–∑–≥–æ–≤–æ—Ä –º–µ–∂–¥—É –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –∏ –∫–ª–∏–µ–Ω—Ç–æ–º.

–¢–∏–ø –∑–≤–æ–Ω–∫–∞: {call_type}
–ú–µ–Ω–µ–¥–∂–µ—Ä –∫–æ–º–ø–∞–Ω–∏–∏: {manager_name}

–ü–û–ú–ù–ò: {manager_name} = –ú–ï–ù–ï–î–ñ–ï–† (–Ω–µ –∫–ª–∏–µ–Ω—Ç!)

–¢–†–ê–ù–°–ö–†–ò–ë–ê–¶–ò–Ø –†–ê–ó–ì–û–í–û–†–ê:
{transcript}
"""


# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞ (–ê–≥–µ–Ω—Ç 2)
VALIDATOR_SYSTEM_PROMPT = """–¢—ã ‚Äî –≤–∞–ª–∏–¥–∞—Ç–æ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏ –Ω–∞–π—Ç–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—É—é –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–£–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–´–ï –ü–û–õ–Ø (–Ω–µ –º–æ–≥—É—Ç –±—ã—Ç—å "–ù–µ —É–∫–∞–∑–∞–Ω–æ"):
1. client_city - –Ω–∞—Å–µ–ª–µ–Ω–Ω—ã–π –ø—É–Ω–∫—Ç, –≥–æ—Ä–æ–¥, —Ä–µ–≥–∏–æ–Ω, –∞–¥—Ä–µ—Å
2. cost - —Å—É–º–º–∞ –¥–æ–≥–æ–≤–æ—Ä–∞, —Å—Ç–æ–∏–º–æ—Å—Ç—å, —Ü–µ–Ω–∞
3. payment_terms - —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã (50/50, –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞, —Ä–∞—Å—Å—Ä–æ—á–∫–∞)
4. next_contact_date - –¥–∞—Ç–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
- –ü–µ—Ä–µ—á–∏—Ç–∞–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –û–ß–ï–ù–¨ –í–ù–ò–ú–ê–¢–ï–õ–¨–ù–û
- –ù–∞–π–¥–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –ø–æ–ª–µ–π
- –ò—â–∏ —Å–∏–Ω–æ–Ω–∏–º—ã –∏ –∫–æ—Å–≤–µ–Ω–Ω—ã–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
- –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –î–ï–ô–°–¢–í–ò–¢–ï–õ–¨–ù–û –Ω–µ—Ç –≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ ‚Äî –≤–µ—Ä–Ω–∏ "–ù–µ —É–∫–∞–∑–∞–Ω–æ"

–ü—Ä–∏–º–µ—Ä—ã —Ç–æ–≥–æ, —á—Ç–æ –Ω—É–∂–Ω–æ –∏—Å–∫–∞—Ç—å:
- –ì–æ—Ä–æ–¥: "—è –∏–∑ –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä–∞", "—É—á–∞—Å—Ç–æ–∫ –≤ –†–æ—Å—Ç–æ–≤–µ", "–∂–∏–≤—É –≤ –ø—Ä–∏–≥–æ—Ä–æ–¥–µ", "–∞–¥—Ä–µ—Å: –ú–æ—Å–∫–≤–∞"
- –°—Ç–æ–∏–º–æ—Å—Ç—å: "25 —Ç—ã—Å—è—á", "–æ–∫–æ–ª–æ 30 000", "—Ü–µ–Ω–∞ –±—É–¥–µ—Ç 40 —Ç—ã—Å—è—á —Ä—É–±–ª–µ–π"
- –û–ø–ª–∞—Ç–∞: "50 –Ω–∞ 50", "–ø–æ–ª–æ–≤–∏–Ω—É —Å–µ–π—á–∞—Å", "–ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 50%", "100% –ø–æ—Å–ª–µ"
- –î–∞—Ç–∞: "–ø–µ—Ä–µ–∑–≤–æ–Ω—é –≤ —Å—Ä–µ–¥—É", "15 —è–Ω–≤–∞—Ä—è", "–∑–∞–≤—Ç—Ä–∞ –ø–æ–∑–≤–æ–Ω—é", "—á–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é"

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û JSON —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:
{
  "client_city": "–Ω–∞–π–¥–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ '–ù–µ —É–∫–∞–∑–∞–Ω–æ'",
  "cost": "–Ω–∞–π–¥–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ '–ù–µ —É–∫–∞–∑–∞–Ω–æ'",
  "payment_terms": "–Ω–∞–π–¥–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ '–ù–µ —É–∫–∞–∑–∞–Ω–æ'",
  "next_contact_date": "–Ω–∞–π–¥–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ '–ù–µ —É–∫–∞–∑–∞–Ω–æ'"
}

–û—Ç–≤–µ—á–∞–π –¢–û–õ–¨–ö–û JSON, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π.
"""


VALIDATOR_USER_PROMPT = """–ü–µ—Ä–≤—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–ø—É—Å—Ç–∏–ª –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

–ü—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –ø–æ–ª—è: {missing_fields}

–¢–†–ê–ù–°–ö–†–ò–ë–ê–¶–ò–Ø –†–ê–ó–ì–û–í–û–†–ê:
{transcript}

–ù–∞–π–¥–∏ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —ç—Ç–∏—Ö –ø–æ–ª–µ–π. –ï—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ—Ç ‚Äî –≤–µ—Ä–Ω–∏ "–ù–µ —É–∫–∞–∑–∞–Ω–æ".
"""


class AnalysisService:
    """–°–µ—Ä–≤–∏—Å –∞–Ω–∞–ª–∏–∑–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–æ–≤ —á–µ—Ä–µ–∑ GPT/Gemini —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π"""
    
    async def _validate_with_gemini(
        self,
        transcript: str,
        missing_fields: List[str]
    ) -> dict:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Gemini (–ê–≥–µ–Ω—Ç 2)"""
        try:
            prepared_transcript = self._prepare_transcript(transcript)
            gemini = _get_gemini_client()
            from google.genai import types
            
            # –°—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ç–æ—Ä–∞
            response_schema = {
                "type": "OBJECT",
                "required": ["client_city", "cost", "payment_terms", "next_contact_date"],
                "properties": {
                    "client_city": {"type": "STRING"},
                    "cost": {"type": "STRING"},
                    "payment_terms": {"type": "STRING"},
                    "next_contact_date": {"type": "STRING"},
                },
            }
            
            prompt = (
                f"{VALIDATOR_SYSTEM_PROMPT}\n\n"
                + VALIDATOR_USER_PROMPT.format(
                    missing_fields=", ".join(missing_fields),
                    transcript=prepared_transcript
                )
            )
            
            response = await gemini.aio.models.generate_content(
                model=GEMINI_MODEL,
                contents=prompt,
                config=types.GenerateContentConfig(
                    temperature=0.1,
                    max_output_tokens=800,  # –í–∞–ª–∏–¥–∞—Ç–æ—Ä—É –Ω—É–∂–Ω–æ –º–µ–Ω—å—à–µ
                    response_mime_type="application/json",
                    response_schema=response_schema,
                ),
            )
            
            result_text = response.text or "{}"
            return json.loads(result_text)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Gemini: {e}")
            return {}
    
    async def _validate_with_openai(
        self,
        transcript: str,
        missing_fields: List[str]
    ) -> dict:
        """–í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ OpenAI (–ê–≥–µ–Ω—Ç 2)"""
        try:
            prepared_transcript = self._prepare_transcript(transcript)
            client = _get_client()
            
            response = await client.chat.completions.create(
                model=OPENAI_MODEL,
                messages=[
                    {"role": "system", "content": VALIDATOR_SYSTEM_PROMPT},
                    {"role": "user", "content": VALIDATOR_USER_PROMPT.format(
                        missing_fields=", ".join(missing_fields),
                        transcript=prepared_transcript
                    )}
                ],
                temperature=0.1,
                max_tokens=800,
                response_format={"type": "json_object"}
            )
            
            result_text = response.choices[0].message.content
            return json.loads(result_text)
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ OpenAI: {e}")
            return {}
    
    async def _validate_and_fix(
        self,
        analysis: CallAnalysis,
        transcript: str,
        manager_name: str
    ) -> CallAnalysis:
        """
        –í—Ç–æ—Ä–æ–π –∞–≥–µ–Ω—Ç: –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –ø–µ—Ä–≤–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
        required_fields = {
            "client_city": analysis.client_city,
            "cost": analysis.cost,
            "payment_terms": analysis.payment_terms,
            "next_contact_date": analysis.next_contact_date
        }
        
        missing = [
            field for field, value in required_fields.items()
            if value in ["–ù–µ —É–∫–∞–∑–∞–Ω–æ", "–ù–µ –æ–±—Å—É–∂–¥–∞–ª–∏", "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è", ""]
        ]
        
        if not missing:
            logger.info("‚úÖ –í—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã, –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è")
            return analysis
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∞–ª–∏–¥–∞—Ç–æ—Ä (–ê–≥–µ–Ω—Ç 2)
        logger.warning(f"‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: {missing}")
        logger.info("üîç –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∞–ª–∏–¥–∞—Ç–æ—Ä (–ê–≥–µ–Ω—Ç 2) –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏...")
        
        provider = (LLM_PROVIDER or "openai").strip().lower()
        
        if provider == "gemini":
            fixed_data = await self._validate_with_gemini(transcript, missing)
        else:
            fixed_data = await self._validate_with_openai(transcript, missing)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –∞–Ω–∞–ª–∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
        updated_count = 0
        for field in missing:
            new_value = fixed_data.get(field, "")
            if new_value and new_value not in ["–ù–µ —É–∫–∞–∑–∞–Ω–æ", "–ù–µ –æ–±—Å—É–∂–¥–∞–ª–∏", ""]:
                old_value = getattr(analysis, field)
                setattr(analysis, field, new_value)
                logger.info(f"‚úÖ –í–∞–ª–∏–¥–∞—Ç–æ—Ä –Ω–∞—à—ë–ª {field}: '{old_value}' ‚Üí '{new_value}'")
                updated_count += 1
        
        if updated_count > 0:
            logger.info(f"üéâ –í–∞–ª–∏–¥–∞—Ç–æ—Ä –∏—Å–ø—Ä–∞–≤–∏–ª {updated_count} –∏–∑ {len(missing)} –ø–æ–ª–µ–π")
        else:
            logger.warning("‚ö†Ô∏è –í–∞–ª–∏–¥–∞—Ç–æ—Ä –Ω–µ —Å–º–æ–≥ –Ω–∞–π—Ç–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é")
        
        return analysis
    
    def _prepare_transcript(self, transcript: str) -> str:
        """
        –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.
        –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ù–ï –æ–±—Ä–µ–∑–∞–µ–º: –¥–ª—è –∑–≤–æ–Ω–∫–æ–≤ –¥–æ ~30 –º–∏–Ω—É—Ç —Ö–æ—Ç–∏–º –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å —Ç–µ–∫—Å—Ç.
        –ï—Å–ª–∏ TRUNCATE_TRANSCRIPT_FOR_ANALYSIS=true –∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è ‚Äî
        –±–µ—Ä—ë–º –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü (–≥–¥–µ –æ–±—ã—á–Ω–æ –∫–ª—é—á–µ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è) –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤.
        """
        if not TRUNCATE_TRANSCRIPT_FOR_ANALYSIS:
            return transcript

        if len(transcript) <= MAX_TRANSCRIPT_LENGTH:
            return transcript
        
        logger.info(f"–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –¥–ª–∏–Ω–Ω–∞—è ({len(transcript)} —Å–∏–º–≤–æ–ª–æ–≤), –æ–±—Ä–µ–∑–∞–µ–º –¥–æ {MAX_TRANSCRIPT_LENGTH}")
        
        # –ë–µ—Ä—ë–º –Ω–∞—á–∞–ª–æ (–ø–µ—Ä–≤—ã–µ 60%) –∏ –∫–æ–Ω–µ—Ü (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 40%)
        # –≠—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –≤ –Ω–∞—á–∞–ª–µ –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Ü–µ
        start_length = int(MAX_TRANSCRIPT_LENGTH * 0.6)
        end_length = MAX_TRANSCRIPT_LENGTH - start_length
        
        start_part = transcript[:start_length]
        end_part = transcript[-end_length:]
        
        prepared = f"""{start_part}

[... –ø—Ä–æ–ø—É—â–µ–Ω–∞ —Å—Ä–µ–¥–Ω—è—è —á–∞—Å—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ ...]

{end_part}"""
        
        logger.info(f"–û–±—Ä–µ–∑–∞–Ω–Ω–∞—è —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è: {len(prepared)} —Å–∏–º–≤–æ–ª–æ–≤")
        return prepared
    
    async def analyze_call(
        self, 
        transcript: str,
        call_type: str = "outgoing",
        manager_name: str = "–ú–µ–Ω–µ–¥–∂–µ—Ä"
    ) -> CallAnalysis:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏—é –∑–≤–æ–Ω–∫–∞ –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
        """
        try:
            logger.info(f"–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–∞–∑–≥–æ–≤–æ—Ä ({len(transcript)} —Å–∏–º–≤–æ–ª–æ–≤)...")
            
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é (–æ–±—Ä–µ–∑–∞–µ–º –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–∞—è)
            prepared_transcript = self._prepare_transcript(transcript)
            
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–ª–∏–Ω—É –∑–≤–æ–Ω–∫–∞ –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
            is_long_call = len(transcript) > 8000  # –ø—Ä–∏–º–µ—Ä–Ω–æ 5+ –º–∏–Ω—É—Ç
            
            call_type_ru = "–í—Ö–æ–¥—è—â–∏–π" if call_type == "incoming" else "–ò—Å—Ö–æ–¥—è—â–∏–π"

            provider = (LLM_PROVIDER or "openai").strip().lower()
            
            # –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º max_tokens –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–ª–∏–Ω—ã –∑–≤–æ–Ω–∫–∞
            if is_long_call:
                max_tokens = OPENAI_MAX_TOKENS
                max_output_tokens = GEMINI_MAX_OUTPUT_TOKENS
                logger.info(f"–î–ª–∏–Ω–Ω—ã–π –∑–≤–æ–Ω–æ–∫, –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ –ª–∏–º–∏—Ç—ã: {max_tokens} —Ç–æ–∫–µ–Ω–æ–≤")
            else:
                max_tokens = min(OPENAI_MAX_TOKENS, 1500)
                max_output_tokens = min(GEMINI_MAX_OUTPUT_TOKENS, 2000)
                logger.info(f"–ö–æ—Ä–æ—Ç–∫–∏–π –∑–≤–æ–Ω–æ–∫, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ª–∏–º–∏—Ç—ã: {max_tokens} —Ç–æ–∫–µ–Ω–æ–≤")

            if provider == "gemini":
                gemini = _get_gemini_client()
                from google.genai import types

                # –°—Ö–µ–º–∞ –æ—Ç–≤–µ—Ç–∞: —Å—Ç—Ä–æ–≥–æ JSON-–æ–±—ä–µ–∫—Ç —Å –æ–∂–∏–¥–∞–µ–º—ã–º–∏ –ø–æ–ª—è–º–∏.
                response_schema = {
                    "type": "OBJECT",
                    "required": [
                        "client_name",
                        "manager_name",
                        "summary",
                        "client_city",
                        "work_type",
                        "cost",
                        "payment_terms",
                        "call_result",
                        "next_contact_date",
                        "next_steps",
                    ],
                    "properties": {
                        "client_name": {"type": "STRING"},
                        "manager_name": {"type": "STRING"},
                        "summary": {"type": "STRING"},
                        "client_city": {"type": "STRING"},
                        "work_type": {"type": "STRING"},
                        "cost": {"type": "STRING"},
                        "payment_terms": {"type": "STRING"},
                        "call_result": {"type": "STRING"},
                        "next_contact_date": {"type": "STRING"},
                        "next_steps": {"type": "ARRAY", "items": {"type": "STRING"}},
                    },
                }

                prompt = (
                    ANALYSIS_SYSTEM_PROMPT.format(manager_name=manager_name) + "\n\n"
                    + ANALYSIS_USER_PROMPT.format(
                        transcript=prepared_transcript,
                        call_type=call_type_ru,
                        manager_name=manager_name,
                    )
                )

                response = await gemini.aio.models.generate_content(
                    model=GEMINI_MODEL,
                    contents=prompt,
                    config=types.GenerateContentConfig(
                        temperature=ANALYSIS_TEMPERATURE,
                        max_output_tokens=max_output_tokens,
                        response_mime_type="application/json",
                        response_schema=response_schema,
                    ),
                )

                result_text = response.text or ""
                result_json = json.loads(result_text)

            else:
                client = _get_client()
                response = await client.chat.completions.create(
                    model=OPENAI_MODEL,
                    messages=[
                        {"role": "system", "content": ANALYSIS_SYSTEM_PROMPT.format(manager_name=manager_name)},
                        {"role": "user", "content": ANALYSIS_USER_PROMPT.format(
                            transcript=prepared_transcript,
                            call_type=call_type_ru,
                            manager_name=manager_name
                        )}
                    ],
                    temperature=ANALYSIS_TEMPERATURE,
                    max_tokens=max_tokens,
                    response_format={"type": "json_object"}
                )

                result_text = response.choices[0].message.content
                result_json = json.loads(result_text)

            next_steps = result_json.get("next_steps") or []
            if not isinstance(next_steps, list):
                next_steps = []
            
            # –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (–ê–≥–µ–Ω—Ç 1)
            analysis = CallAnalysis(
                client_name=result_json.get("client_name", "–ö–ª–∏–µ–Ω—Ç"),
                manager_name=result_json.get("manager_name", manager_name),
                summary=result_json.get("summary", ""),
                client_city=result_json.get("client_city", "–ù–µ —É–∫–∞–∑–∞–Ω–æ"),
                work_type=result_json.get("work_type", "–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"),
                cost=result_json.get("cost", "–ù–µ –æ–±—Å—É–∂–¥–∞–ª–∏"),
                payment_terms=result_json.get("payment_terms", "–ù–µ –æ–±—Å—É–∂–¥–∞–ª–∏"),
                call_result=result_json.get("call_result", "–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ"),
                next_contact_date=result_json.get("next_contact_date", "–ù–µ —É–∫–∞–∑–∞–Ω–æ"),
                next_steps=[str(x).strip() for x in next_steps if str(x).strip()][:5],
            )
            
            logger.info("‚úÖ –ê–≥–µ–Ω—Ç 1 (–∞–Ω–∞–ª–∏–∑) –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É")
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∞–ª–∏–¥–∞—Ç–æ—Ä (–ê–≥–µ–Ω—Ç 2)
            validated_analysis = await self._validate_and_fix(
                analysis,
                transcript,  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é
                manager_name
            )
            
            logger.info("‚úÖ –ê–≥–µ–Ω—Ç 2 (–≤–∞–ª–∏–¥–∞—Ü–∏—è) –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É")
            return validated_analysis
            
        except json.JSONDecodeError as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç GPT: {e}")
            raise
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: {e}")
            raise
    
    def format_note(
        self, 
        analysis: CallAnalysis,
        call_type: str = "outgoing",
        duration_seconds: float = 0,
        manager_name: str = "–ú–µ–Ω–µ–¥–∂–µ—Ä"
    ) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞ –≤ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –¥–ª—è AmoCRM.
        """
        minutes = int(duration_seconds // 60)
        seconds = int(duration_seconds % 60)
        duration_str = f"{minutes} –º–∏–Ω {seconds} —Å–µ–∫" if minutes else f"{seconds} —Å–µ–∫"
        call_type_str = "–ò—Å—Ö–æ–¥—è—â–∏–π" if call_type == "outgoing" else "–í—Ö–æ–¥—è—â–∏–π"

        steps_block = ""
        if analysis.next_steps:
            steps_block = "\n\n‚úÖ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:\n" + "\n".join([f"- {s}" for s in analysis.next_steps])
        
        note = f"""üéôÔ∏è –ê–ù–ê–õ–ò–ó –ó–í–û–ù–ö–ê (AI)

üìû {call_type_str} | {duration_str}

–°–ø–∏–∫–µ—Ä—ã:
- {analysis.manager_name} (–º–µ–Ω–µ–¥–∂–µ—Ä)
- {analysis.client_name} (–∫–ª–∏–µ–Ω—Ç)

–°—É—Ç—å:
{analysis.summary}

üìç –ì–æ—Ä–æ–¥: {analysis.client_city}
üîß –†–∞–±–æ—Ç–∞: {analysis.work_type}
üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å: {analysis.cost}
üí≥ –û–ø–ª–∞—Ç–∞: {analysis.payment_terms}
üìä –ò—Ç–æ–≥: {analysis.call_result}
üìÖ –°–ª–µ–¥—É—é—â–∏–π –∫–æ–Ω—Ç–∞–∫—Ç: {analysis.next_contact_date}{steps_block}"""
        
        return note


# –°–∏–Ω–≥–ª—Ç–æ–Ω
analysis_service = AnalysisService()
